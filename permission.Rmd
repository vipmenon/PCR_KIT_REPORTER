---
title: "贝格尔医学检验实验室"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(DT)
library(DBI)
library(dplyr)
library(tibble)
library(shinyjs)
library(plotly)

# operation id
UPDATEID = 3
INSERTID = 2
DELETEID = 4

mydb <- dbConnect(RMySQL::MySQL(), dbname='BEAGLE_LIMS', username='lims',
                  password='lims', host='192.168.253.178', port=3306)
dbSendQuery(mydb,"SET NAMES utf8")

get_select_list <- function(table, key_col, value_col) {
  sel_tbl <- as_tibble(DBI::dbReadTable(mydb, table))
  sel_lst <- as.list(sel_tbl %>% pull(value_col))
  names(sel_lst) <- sel_tbl %>% pull(key_col)
  return(sel_lst)
}
```

权限管理
=====================================  

Column {.sidebar data-width=350}
-----------------------------------------------------------------------

最后更新日期：`r file.mtime("permission.Rmd")`

```{r}
TABLE = "Permission"

rv <- reactiveValues(permission = list(view = FALSE, insert = FALSE, delete = FALSE),
                     table = as_tibble(DBI::dbReadTable(mydb, TABLE)))
## 主窗口表格内容
mainTbl_sql <- "SELECT p.id `记录编号`, u.name `姓名`, o.chinese `操作类别`,
                       t.chinese `管理模块`, if(p.isValid = 0,'否','是') `是否有效`,
                       p.updatetime `更新日期`
                 FROM `Permission` p
                 LEFT JOIN `User` u on u.userKey = p.userId
                 LEFT JOIN `Operation` o on o.id = p.operationId
                 LEFT JOIN `Table` t on t.id = p.tableId"
rv$mainTbl <- dbGetQuery(mydb, mainTbl_sql)

passwordInput("userKey", label = "用户钥匙", value = NA)
textOutput("p")
```

***

```{r}
useShinyjs(rmd=TRUE)

numericInput("id", label = "记录编号", value = NA, min = 1)

selectInput("userId", label = "姓名", choices = get_select_list("`User`", "name", "userKey"))

selectInput("tableId", label = "管理模块", choices = get_select_list("`Table`", "chinese", "id"))

selectInput("operationId", label = "操作类别", choices = get_select_list("`Operation`", "chinese", "id"))

selectInput("isValid", label = "是否有效", choices = list("是" = 1, "否" = 0))

actionButton("submit", label = "新增/更新")

query_id <- "id" ## primary id

update_ary <- c("userId", "tableId", "operationId", "isValid")

tags$span(" ")

actionButton("delete", "删除")

observeEvent(input$userKey, {
  # 查询用户permission
  if (input$userKey == "") {
    rv$user <- tibble(userKey = integer(), permission = character())
  } else {
    user_sql <- paste("SELECT u.`userKey`, u.`name` `name`, o.`chinese` `permission`, t.`name` tname, p.isValid
                FROM `Permission` p
                LEFT JOIN `User` u on p.userId = u.userKey
                LEFT JOIN `Operation` o on p.`operationId` = o.`id`
                LEFT JOIN `Table` t on p.`tableId` = t.`id`
                WHERE t.`name` = '", TABLE, "'
                AND u.isValid = 1
                AND u.`userKey` = ", input$userKey, sep = "")
    rv$user <- dbGetQuery(mydb, user_sql)
  }

  permissions <- rv$user %>% filter(userKey == input$userKey, isValid == 1) %>%
                         pull(permission)
  rv$permission[["view"]] <- ifelse("查询" %in% permissions, TRUE, FALSE)
  rv$permission[["delete"]] <- ifelse("删除" %in% permissions, TRUE, FALSE)
  rv$permission[["insert"]] <- ifelse("新增" %in% permissions, TRUE, FALSE)

  output$p <- renderText(paste("用户权限：", paste(permissions, collapse = "、")))

  if (rv$permission[["view"]] == TRUE) {
    if (nrow(rv$mainTbl) > 0) {
      output$mainTbl <- renderDT(rv$mainTbl, filter = 'top', options =
                                   list(pageLength = 15, autoWidth = TRUE), rownames= FALSE)
      output$logText <- renderPrint(rv$log_text)
      output$chartA <- renderPlotly(plot_ly(rv$mainTbl %>%
                                              group_by(`管理模块`) %>%
                                              summarise(Num = length(`管理模块`)),
                                            x = ~`管理模块`, y = ~`Num`, type = "bar"))
    } else {
      output$mainTbl <- renderDT(tibble())
      output$logText <- renderPrint("")
      output$chartA <- renderPlotly(plot_ly(type = "bar"))
    }
  }

  if (rv$permission[["delete"]]) {
    show("delete")
  } else {
    hide("delete")
  }
  
  if (rv$permission[["insert"]]) {
    for(ele in c(query_id, update_ary)) {
      show(ele)
      show("submit")
    }
  } else {
    for(ele in c(query_id, update_ary)) {
      hide(ele)
      hide("submit")
    }
  }
  
})

observeEvent(input[[query_id]], {
  
  if (rv$permission[["view"]]) {
    for (field in update_ary) {
      updateTextInput(session, field, value = rv$table %>%
                      filter(get(query_id) == input[[query_id]]) %>%
                      pull(field))
    }
  } else {
    renderText("用户权限不足")
  }

})

get_table_id <- function(table) {
  # get table id using table name
  table_sql <- paste("SELECT `id` FROM `Table` WHERE `name` = '", table, "'", sep = "")
  table_rv <- dbGetQuery(mydb, table_sql)
  if (nrow(table_rv) == 0) {
    stop("Table not found!")
  } else {
    return(table_rv$id[1])
  }
}

# 日志记录查询

get_log <- function(table) {
  log_sql <- paste("SELECT u.name name, o.chinese operation, t.chinese `table`, recordId, `timestamp` `time`
  FROM Log l
  LEFT JOIN `User` u on u.userKey = l.userKey
  LEFT JOIN `Operation` o on l.operationId = o.id
  LEFT JOIN `Table` t on l.tableId = t.id
  WHERE t.name = '", table, "'", sep = "")
  
  log_tbl <- dbGetQuery(mydb, log_sql)
  
  if (nrow(log_tbl) > 0) {
    paste(log_tbl$name, "于", log_tbl$time, "在", log_tbl$table, "中", log_tbl$operation, "了第", log_tbl$recordId,"号记录", sep = "")
  } else {
    return("无操作记录")
  }
}

rv$log_text <- get_log(TABLE)

## 新增与更新

observeEvent(input$submit, {
  validate(
    need(input$userId, '请选择用户'),
    need(input$tableId, '请选择模块'),
    need(input$operationId, '请选择操作'),
    need(input$isValid, '请选择是否有效')
  )
  ## NULL value manipulation
  # serialNumber <- ifelse(input$serialNumber == "", "NULL", input$serialNumber)
  # dateCommissioned <- ifelse(toString(input$dateCommissioned) == "", "NULL", toString(input$dateCommissioned))
  submitValues <- paste(input[[query_id]], input$userId, input$tableId, input$operationId, input$isValid, "now()", sep = ", ")
  insert_sql <- paste("INSERT INTO `", TABLE, "` VALUES (", submitValues, ") ON DUPLICATE KEY UPDATE
          userId = ", input$userId, ",
          tableId = ", input$tableId, ",
          operationId = ", input$operationId, ",
          isValid = ", input$isValid, sep = "")
  # insert_sql <- gsub("'NULL'", "NULL", insert_sql)
  rv$sql_exe <- dbExecute(mydb, insert_sql)
  
  # 添加日志
  
  if (input[[query_id]] %in% rv$table[[query_id]]) {
    log_values <- paste(input$userKey, get_table_id(TABLE), UPDATEID,
                  input[[query_id]], sep = ", ")
  } else {
    log_values <- paste(input$userKey, get_table_id(TABLE), INSERTID,
                  input[[query_id]], sep = ", ")
  }
  log_ins_sql <- paste("INSERT INTO `Log`(`userKey`, `tableId`, `operationId`, `recordId`, `values`, `timestamp`) VALUES (", log_values, ", \"", submitValues, "\" , now())", sep = "")
  dbExecute(mydb, log_ins_sql)
  rv$log_text <- get_log(TABLE)
  
  ## 刷新主表格内容
  rv$mainTbl <- dbGetQuery(mydb, mainTbl_sql)
})

# 删除记录

observeEvent(input$delete, {
  delete_sql <- paste("DELETE FROM `", TABLE, "` WHERE `", query_id, "` = ", input[[query_id]], sep = "")
  rv$sql_exe <- dbExecute(mydb, delete_sql)
  
  # 添加日志
  
  log_values <- paste(input$userKey, get_table_id(TABLE), DELETEID,
                input[[query_id]], sep = ", ")

  log_ins_sql <- paste("INSERT INTO `Log`(`userKey`, `tableId`, `operationId`, `recordId`, `values`, `timestamp`) VALUES (", log_values, ", \"", NULL, "\" , now())", sep = "")
  dbExecute(mydb, log_ins_sql)
  rv$log_text <- get_log(TABLE)
  
  rv$table <- as_tibble(DBI::dbReadTable(mydb, TABLE))
  
})

```


Column {data-width=450}
-----------------------------------------------------------------------

### 仪器列表

```{r}
DT::dataTableOutput("mainTbl")
```

Column {data-width=200}
-----------------------------------------------------------------------

### 操作日志

```{r}
verbatimTextOutput("logText")

```

### 汇总计数

```{r}
plotlyOutput("chartA")
```

